\input{src/preamble.tex}

\begin{document}
  \frame[plain,noframenumbering]{\titlepage}

  \frame[plain,noframenumbering]{
    \frametitle{}
    \LARGE{\textbf{Überblick}}
    \vspace{1em}
    \large
    \begin{enumerate}
      \item Problemstellung
      \item Statische Typsysteme für JavaScript
      \item Umsetzung des Transpilers
      \item Ergebnisse und Auswertung
      \item Fazit
    \end{enumerate}
  }

  \section{Problemstellung}
    \secframe{Problemstellung}

    \begin{frame}
      \frametitle{Motivation}
      \begin{itemize}
        \item JavaScripts \textbf{dynamische Typisierung} erschwert die Entwicklung korrekter, sicherer und wartbarer Anwendungen~\autocite{NIKHIL:2014,PRADEL:2015,BIERMAN:2014}
        \item Typ von Werten wird zur Laufzeit implizit umgewandelt (\textit{type coercion})
        \item Kritisches Laufzeitverhalten wird zum Teil ignoriert
        \item aber: Erkennung von Programmfehlern durch Einsatz eines \textbf{statischen Typsystems} möglich
        \item Zwei Vertreter: \textit{Flow}~\autocite{FLOW:PAPER} und \textit{TypeScript}~\autocite{TYPESCRIPT:SPEC}
      \end{itemize}
    \end{frame}

    \begin{frame}[fragile]
      \frametitle{Beispiel -- Statische Typisierung durch Flow}
      \begin{lstlisting}
function linearSearch<T>(list: Array<T>, searchValue: T): number | null {
  for (const [index, value] of list.entries()) {
    if (value === searchValue) {
      return index;
    }
  }
  return null;
}

linearSearch<number>([3, 56, 10], 56);           // 1
linearSearch<number>([3, 56, 10], 12);           // null
linearSearch<string>(['foo', 'bar', 'baz'], 3);  // Typfehler
      \end{lstlisting}
    \end{frame}

    \frame{
      \frametitle{Zielsetzung der Masterarbeit}
      \begin{itemize}
        \item Ausgangslage: \textit{Spreadshirt} setzt Flow zur statischen Typisierung von JavaScript-Anwendungen ein
        \item Ziel: Migration bestehender Flow"=Projekte nach TypeScript
        \item Händische Migration fehleranfällig und zeitaufwändig
        \item Lösung: Entwicklung eines \textbf{Transpilers} zur Übersetzung der Flow-Typisierung nach TypeScript
        \item Transpiler = Compiler, der Quelltext einer Programmier"=sprache in eine andere übersetzt
      \end{itemize}
    }

    \begin{frame}[fragile]
      \frametitle{Beispiel einer Typ-Übersetzung}

      \begin{lstlisting}[
        numbers=none,
        basicstyle=\linespread{1.04}\large\ttfamily,
        emph={number,null,undefined},
      ]
// Flow
type MaybeNumber = ?number;

// TypeScript
type MaybeNumber = number | null | undefined;
      \end{lstlisting}
    \end{frame}

    \begin{frame}
      \frametitle{Ziele der Migration zu TypeScript}
      \textbf{Z1}\hspace{0.75em}Erkennung weiterer Typ- und Programmfehler\\[.6em]
      \textbf{Z2}\hspace{0.75em}Unterstützung externer Bibliotheken\\[.6em]
      \textbf{Z3}\hspace{0.75em}Performance der Typüberprüfungen\\[.6em]
      \textbf{Z4}\hspace{0.75em}Zukunftssicherheit und Transparenz der Technologie
    \end{frame}

  \section{Statische Typsysteme}
  \secframe{Statische Typsysteme\secframebr für JavaScript}

    \begin{frame}
      \frametitle{Flow}
      \begin{itemize}
        \item ermöglicht Verwendung von Typannotationen in\\regulären JavaScript-Quelltexten
        \item Typüberprüfung durch Server im Hintergrund
        \item Fokus auf Korrektheit\footnote{engl. \textit{Soundness}} des Typsystems
        \item globale Typinferenz durch pfadsensitive Datenflussanalyse
        \item Typsystem größtenteils strukturell, z. T. nominal
        \item Parallelisierung der Berechnung
      \end{itemize}
    \end{frame}

    \begin{frame}
      \frametitle{TypeScript}
      \begin{itemize}
        \item vollständige Programmiersprache mit\\statischer Typisierung
        \item Syntax ist strikte Obermenge von JavaScript
        \item Typüberprüfung und Übersetzung nach JavaScript\\durch TypeScript-Compiler
        \item \enquote{\textit{Balance zwischen Korrektheit und Produktivität}}~\autocite{TYPESCRIPT:DESIGN_GOALS}
        \item Typinferenz nur lokal und teilweise kontextuell
        \item Typsystem rein strukturell
        \item graduelle Typisierung möglich
      \end{itemize}
    \end{frame}

  \section{Umsetzung}
    \secframe{Umsetzung des\secframebr Transpilers}

    \begin{frame}
      \frametitle{Technische Anforderungen an den Transpiler}
      \textbf{A1}\hspace{0.75em}Äquivalente und vollständige Übersetzung der Flow-Typen\\[.6em]
      \textbf{A2}\hspace{0.75em}Beibehaltung der Programmsemantik\\[.6em]
      \textbf{A3}\hspace{0.75em}Unterstützung aktueller und vorläufiger JavaScript- sowie\\\hspace{2.05em}JSX-Syntax\\[.6em]
      \textbf{A4}\hspace{0.75em}Verarbeitung gesamter Projektverzeichnisse\\[.6em]
      \textbf{A5}\hspace{0.75em}Beibehaltung der Quelltextformatierung
    \end{frame}

    \begin{frame}
      \frametitle{Implementierung als Babel-Plugin}
      \begin{itemize}
        \item \textit{Babel}~\autocite{BABEL} als Grundlage der Implementierung gewählt
        \item Babel = Transpiler für JavaScript
        \item unterstützt alle geforderten Arten von Syntax
        \item gute Erweiterbarkeit durch Plugin-System
        \item sehr ausgereiftes Projekt
      \end{itemize}
    \end{frame}

    \begin{frame}
      \frametitle{Programmtransformation durch Babel}
      \textbf{\large Grundkonzept}
      \vspace{1em}
      \begin{enumerate}
        \item Parsen des Eingabequelltexts\linebreak$\Rightarrow$ abstrakter Syntaxbaum (AST) des Programms\\
        \smallskip
        \item \textbf{Programmtransformation} durch Manipulation der AST-Knoten mittels \textit{Besucher-Entwurfsmuster}\\
        \smallskip
        \item Generierung des Ausgabequelltexts
      \end{enumerate}
    \end{frame}

    \begin{frame}[fragile]
      \frametitle{Transformation des abstrakten Syntaxbaums}

      \begin{columns}
        \begin{column}{.48\textwidth}
          \begin{lstlisting}[numbers=none]
// @flow
type Alias = mixed;
          \end{lstlisting}
          \vspace{5mm}
          \ttfamily
          \begin{forest}
            for tree = {l=1.6cm, s sep=0.4cm}
            [Program
              [TypeAlias, edge label={node[edge]{body}}
                [Identifier, edge label={node[edge]{id}}
                  [\enquote{Alias}, edge label={node[edge]{name}}]
                ]
                [MixedTypeAnnotation, edge label={node[edge]{right}}]
              ]
            ]
          \end{forest}
        \end{column}
        \begin{column}{.04\textwidth}

        \end{column}
        \begin{column}{.48\textwidth}
          \begin{lstlisting}[numbers=none]
  // TypeScript
  type Alias = unknown;
          \end{lstlisting}
          \vspace{5mm}
          \ttfamily
          \begin{forest}
            for tree = {l=1.6cm, s sep=0.5cm}
            [Program
              [TSTypeAliasDeclaration, edge label={node[edge]{body}}
                [Identifier, edge label={node[edge]{id}}
                  [\enquote{Alias}, edge label={node[edge]{name}}]
                ]
                [TSUnknownKeyword, edge label={node[edge]{typeAnnotation}}]
              ]
            ]
          \end{forest}
        \end{column}
      \end{columns}
    \end{frame}

    \begin{frame}
      \vspace{1mm}
      \begin{columns}
        \column{\dimexpr\paperwidth-8mm}
        \begin{figure}
          \includegraphics[width=\textwidth]{src/figures/architecture-overview.pdf}
        \end{figure}
      \end{columns}
    \end{frame}

    % \begin{frame}
    %   \frametitle{Spezialfälle}
    %   TODO: Spezialfälle der Transformation
    % \end{frame}

  \section{Ergebnisse}
    \secframe{Ergebnisse und\secframebr Auswertung}

    % \begin{frame}
    %   \frametitle{Durchführung der Migration}
    %   \begin{itemize}
    %     \item Zwei Projekte von Spreadshirt wurden mit Hilfe des Transpilers erfolgreich migriert
    %     \item aber: daraufhin zahlreiche neue Typfehler
    %     \item manuelle Korrektur dieser Fehler notwendig
    %   \end{itemize}
    % \end{frame}

    \subsection{Technische Anforderungen}
      % \begin{frame}
      %   \LARGE\textbf{Erfüllung der technischen Anforderungen}
      % \end{frame}

      \begin{frame}
        \frametitle{A1\hspace{0.75em}Äquivalenz und Vollständigkeit der Transf. (1)}
        \begin{block}{Äquivalenz der Übersetzungen}
          \begin{itemize}
            \item wurde größtenteils erzielt
            \item aber: einzelne Funktionen von Flow werden in TypeScript nicht unterstützt\\
              \smallskip
              $\Rightarrow$ Verlust von Typinformation
            \item für 3 der 17 Hilfstypen von Flow konnte kein äquivalenter TypeScript-Ausdruck gefunden werden\\
              \smallskip
              $\Rightarrow$ Ersetzung mit \textit{any}
          \end{itemize}
        \end{block}
      \end{frame}

      \begin{frame}
        \frametitle{A1\hspace{0.75em}Äquivalenz und Vollständigkeit der Transf. (2)}
        \begin{block}{Vollständigkeit der Transformationen}
          \begin{itemize}
            \item wurde erzielt
            \item Umfang der \textit{Vollständigkeit} durch AST-Spezifikation~\autocite{BABEL:PARSER_SPEC} von Babel präzise eingegrenzt
            \item Verifizierung durch 1022 Fixture-Tests, die alle Funktionen von Flow abbilden
            \item außerdem: Überprüfung der Implementierung durch statische Typisierung von Babel
          \end{itemize}
        \end{block}
      \end{frame}

      \begin{frame}
        \frametitle{A2\hspace{0.75em}Beibehaltung der Programmsemantik}
          \begin{itemize}
            \item Voraussetzung: Transpiler adressiert lediglich Flow-Typen und hat keine unbeabsichtigte Nebenwirkung
            \item Verifizierung durch Fixture-Tests
            \item Überprüfung der Beibehaltung der Semantik durch 373 bzw. 326 Modultests der migrierten Projekte\\
              \smallskip
              $\Rightarrow$ keine Fehler
            \item aber: Testabdeckung bei 90,5\% bzw. lediglich 18,0\%
            \item Erfüllung der Anforderung wird angenommen
          \end{itemize}
      \end{frame}

      \begin{frame}
        \frametitle{A3\hspace{0.75em}Unterstützung von JavaScript- und JSX-Syntax}
      \end{frame}

      \begin{frame}
        \frametitle{A4\hspace{0.75em}Verarbeitung gesamter Projektverzeichnisse}
      \end{frame}

      \begin{frame}
        \frametitle{A5\hspace{0.75em}Beibehaltung der Quelltextformatierung}
        \begin{itemize}
          \item ursprüngliche Quelltextformatierung geht durch Transpilierung verloren
          \item deshalb: Formatierungsroutine auf Basis von\\\textit{Prettier}~\autocite{SOFTWARE:PRETTIER} implementiert
          \item Manuelle Überprüfung der originalgetreuen\\Formatierung der Ausgabe in zwei Projekten:\\
            \medskip
            \hspace{1em}Projekt A:~~3,5\% Fehlerrate\\
            \smallskip
            \hspace{1em}Projekt B:~~5,9\% Fehlerrate
          \item Somit: vereinzelt fehlerhafte Formatierung, aber insgesamt zu 95,3\% korrekt
        \end{itemize}
      \end{frame}

    \subsection{Ziele}
      % \begin{frame}
      %   \LARGE\textbf{Erfüllung der Zielvorgaben}
      % \end{frame}

      \begin{frame}
        \frametitle{Z1\hspace{0.75em}Erkennung weiterer Typ- und Programmfehler}
      \end{frame}

      \begin{frame}
        \frametitle{Z2\hspace{0.75em}Unterstützung externer Bibliotheken}
      \end{frame}

      \begin{frame}
        \frametitle{Z3\hspace{0.75em}Performance der Typüberprüfungen}
      \end{frame}

      \begin{frame}
        \frametitle{Z4\hspace{0.75em}Zukunftssicherheit und Transparenz}
      \end{frame}

  \section{Fazit}
    \secframe{Fazit}

    \begin{frame}
      \frametitle{Fazit}

      \begin{block}{Erfüllung der Ziele}
        \begin{enumerate}
          \item Erkennung weiterer Typ- und Programmfehler
          \item Unterstützung externer Bibliotheken
          \item Performance der Typüberprüfungen
          \item Zukunftssicherheit und Transparenz der Technologie
        \end{enumerate}
      \end{block}
    \end{frame}

  \appendix

    \begin{frame}[noframenumbering,plain]
      % empty
    \end{frame}

  \section{Backup}
    \setbeamertemplate{footline}{}

    \begin{frame}[noframenumbering]
      \frametitle{Evaluation bestehender Werkzeuge}
      \input{src/tables/tools.tex}
    \end{frame}

    \begin{frame}
      \frametitle{Nicht äquivalent übersetzbare Flow-Funktionen}
      \begin{itemize}
        \item \textit{Existential type}
        \item Beliebige Typen in Index-Signaturen von Objekttypen
        \item \textit{Opaque type}
        \item Expliziter Rückgabewert von Konstruktoren
        \item Varianz\footnote{TypeScript unterstützt nur Kovarianz}
      \end{itemize}
    \end{frame}

    \begin{frame}[plain,allowframebreaks,noframenumbering]
      \frametitle{Quellenverzeichnis}
      \printbibliography
    \end{frame}
\end{document}
